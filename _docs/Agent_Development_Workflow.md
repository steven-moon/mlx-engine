# Agent-Driven Development Workflow

> **Purpose**: Optimize Cursor for agent-driven development with automatic simulator testing  
> **Status**: âœ… **IMPLEMENTED**  
> **Priority**: ðŸ”´ **CRITICAL - CORE WORKFLOW**

---

## Logging Rule (2024-06-27)

**All logs generated by scripts or automation must be written to `/tmp` or a dedicated `logs/` directory, never to the project root.** This prevents clutter and accidental log commits.

---

## Executive Summary

This document describes the **agent-driven development workflow** that transforms Cursor into an autonomous development assistant. The system automatically builds, tests, and runs your app in the simulator after every code change, eliminating the need for manual commands.

### **Key Benefits:**
- âœ… **Zero Manual Commands**: Agent automatically runs build/test/simulate cycle
- âœ… **Instant Feedback**: Immediate validation of code changes
- âœ… **Error Auto-Fix**: Agent attempts to fix build/test failures automatically
- âœ… **Simulator Integration**: Automatic app launch and log monitoring
- âœ… **Comprehensive Logging**: Detailed logs for debugging and optimization

---

## How It Works

### **Automatic Workflow Trigger**

The agent automatically triggers the development cycle when:

1. **Swift files are saved** (`Ctrl+S` or auto-save)
2. **Project files change** (xcodeproj, project.yml, Package.swift)
3. **Terminal commands are executed** (build, test, run)
4. **Manual agent commands** are issued

### **Development Cycle**

```
Code Change â†’ Build â†’ Test â†’ Simulate â†’ Monitor â†’ Report
```

1. **Code Change**: Edit Swift files or project configuration
2. **Build**: Compile iOS/macOS targets with xcodebuild
3. **Test**: Run unit tests and integration tests
4. **Simulate**: Launch iOS Simulator and install app
5. **Monitor**: Stream app logs for debugging
6. **Report**: Provide status and next steps

---

## Agent Commands

### **Core Commands**

| Command | Description | Auto-Triggered |
|---------|-------------|----------------|
| `build-ios` | Build iOS app for simulator | âœ… On Swift file save |
| `build-macos` | Build macOS app | âœ… On project file change |
| `test` | Run all tests | âœ… After build |
| `clean` | Clean build artifacts | âœ… On project file change |
| `monitor` | Monitor simulator logs | âœ… After simulator launch |
| `reset-sim` | Reset simulator state | ðŸ”§ Manual only |
| `full-cycle` | Complete development cycle | ðŸ”§ Manual only |
| `status` | Show environment status | ðŸ”§ Manual only |

### **Usage Examples**

```bash
# Manual commands (if needed)
./agent_dev_workflow.sh build-ios
./agent_dev_workflow.sh test
./agent_dev_workflow.sh full-cycle
./agent_dev_workflow.sh monitor
```

---

## Agent Behavior Rules

### **MANDATORY Actions**

The agent **ALWAYS** performs these actions after code changes:

1. **Build Validation**: Compile all targets and report success/failure
2. **Test Execution**: Run test suite and report results
3. **Simulator Launch**: Boot simulator and install app
4. **Log Monitoring**: Stream app logs for debugging
5. **Status Reporting**: Provide clear status and next steps

### **Error Handling**

The agent **automatically** handles errors:

- **Build Failures**: Analyze error logs and suggest fixes
- **Test Failures**: Identify failing tests and propose solutions
- **Simulator Issues**: Reset simulator and retry
- **Dependency Issues**: Update packages and regenerate project

### **Communication Pattern**

The agent follows this communication pattern:

```
âœ… Code changes made
ðŸ”¨ Building project...
âœ… Build successful (2.3s)
ðŸ§ª Running tests...
âœ… Tests passed (8/8)
ðŸ“± Launching simulator...
âœ… App installed successfully
ðŸ“Š Monitoring logs...
ðŸŽ¯ Ready for user testing
```

---

## Configuration

### **Cursor Settings**

The agent uses these Cursor settings (`.cursor/settings.json`):

```json
{
  "cursor.agent.enabled": true,
  "cursor.agent.autoRun": true,
  "cursor.agent.autoRunOnSave": true,
  "cursor.agent.autoRunOnFileChange": true,
  "cursor.agent.autoRunOnTerminalCommand": true,
  "cursor.agent.autoRunOnBuild": true,
  "cursor.agent.autoRunOnTest": true,
  "cursor.agent.autoRunOnSimulator": true
}
```

### **Environment Variables**

Set these environment variables for optimal performance:

```bash
export DEVELOPER_DIR="/Applications/Xcode.app/Contents/Developer"
export SIMULATOR_DEVICE="iPhone 16"
export BUILD_SCHEME="MLXChatApp-iOS"
export WORKSPACE_PATH="MLXChatApp/MLXChatApp.xcodeproj/project.xcworkspace"
```

### **Project Configuration**

The agent uses these project-specific settings:

- **Simulator Device**: iPhone 16 (iOS 17.0)
- **Build Scheme**: MLXChatApp-iOS
- **Workspace**: MLXChatApp/MLXChatApp.xcodeproj/project.xcworkspace
- **Derived Data**: /tmp/MLXEngine-build
- **Log File**: /tmp/MLXEngine-build.log

---

## Monitoring & Logging

### **Build Logs**

Build logs are captured in `/tmp/MLXEngine-build.log`:

```bash
# View recent build logs
tail -f /tmp/MLXEngine-build.log

# View build errors only
grep -i "error\|failed" /tmp/MLXEngine-build.log
```

### **Simulator Logs**

The agent monitors simulator logs in real-time:

```bash
# App-specific logs
xcrun simctl spawn booted log stream --predicate 'process == "MLXChatApp"'

# System logs
xcrun simctl spawn booted log stream --predicate 'category == "MLXEngine"'

# Crash logs
xcrun simctl spawn booted log stream --predicate 'eventType == "fault"'
```

### **Performance Metrics**

The agent tracks performance metrics:

- **Build Time**: Target <30 seconds
- **Test Execution**: Target <10 seconds
- **Simulator Launch**: Target <15 seconds
- **App Startup**: Target <5 seconds

---

## Troubleshooting

### **Common Issues**

#### **Build Failures**

```bash
# Clean build artifacts
./agent_dev_workflow.sh clean

# Regenerate project
xcodegen generate

# Check Xcode version
xcodebuild -version
```

#### **Simulator Issues**

```bash
# Reset simulator
./agent_dev_workflow.sh reset-sim

# Check simulator devices
xcrun simctl list devices

# Boot simulator manually
xcrun simctl boot "iPhone 16"
```

#### **Test Failures**

```bash
# Run tests with verbose output
swift test --package-path . --filter MLXEngineTests --verbose

# Run specific test
swift test --package-path . --filter MLXEngineTests.ChatSessionTests
```

### **Agent Debugging**

#### **Enable Debug Logging**

```json
{
  "cursor.agent.logging": {
    "enabled": true,
    "level": "debug",
    "file": "/tmp/cursor-agent-debug.log"
  }
}
```

#### **Check Agent Status**

```bash
# View agent logs
tail -f /tmp/cursor-agent.log

# Check agent configuration
./agent_dev_workflow.sh status
```

---

## Best Practices

### **For Optimal Performance**

1. **Keep Simulator Running**: Don't close simulator between builds
2. **Use Incremental Builds**: Avoid full clean builds unless necessary
3. **Monitor Resource Usage**: Close other apps during intensive builds
4. **Regular Cleanup**: Run `./agent_dev_workflow.sh clean` weekly

### **For Better Error Handling**

1. **Check Logs First**: Always review build/test logs before asking for help
2. **Use Status Command**: Run `./agent_dev_workflow.sh status` to check environment
3. **Reset Simulator**: Use `./agent_dev_workflow.sh reset-sim` for simulator issues
4. **Monitor Resources**: Check CPU/memory usage during builds

### **For Development Efficiency**

1. **Trust the Agent**: Let the agent handle routine tasks automatically
2. **Focus on Code**: Concentrate on writing code, not running commands
3. **Use Full Cycle**: Run `./agent_dev_workflow.sh full-cycle` for major changes
4. **Monitor Logs**: Keep log monitoring active during development

---

## Integration with Existing Workflow

### **Cursor Rules Integration**

The agent workflow integrates with existing Cursor rules:

- **@agent-workflow.mdc**: Core workflow automation
- **@MLXEngine.mdc**: Architecture and coding standards
- **@swift-style.mdc**: Swift coding style enforcement
- **@xcode-cursor-tips.mdc**: Xcode productivity tips

### **Script Integration**

The agent uses these existing scripts:

- **agent_dev_workflow.sh**: Main workflow automation
- **swiftuikit_dev_workflow.sh**: SwiftUIKit integration
- **setup_mlxengine.sh**: Environment setup
- **build_metal_library.sh**: Metal library compilation

### **Documentation Integration**

The workflow references these documents:

- **Xcode_Simulator_Cursor_Tips.md**: Simulator and Xcode tips
- **ChatApp_Implementation_Guide.md**: App development guide
- **architecture.md**: System architecture
- **api_reference.md**: API documentation

---

## Success Metrics

### **Technical Metrics**

- âœ… **Build Success Rate**: >95% successful builds
- âœ… **Test Pass Rate**: >90% test pass rate
- âœ… **Simulator Launch Time**: <15 seconds
- âœ… **App Startup Time**: <5 seconds
- âœ… **Error Recovery Rate**: >80% automatic error recovery

### **User Experience Metrics**

- âœ… **Zero Manual Commands**: No need to run build/test commands
- âœ… **Instant Feedback**: Immediate validation of changes
- âœ… **Clear Status**: Always know what's happening
- âœ… **Error Clarity**: Clear error messages and solutions
- âœ… **Development Speed**: 50% faster development cycle

### **Integration Metrics**

- âœ… **Cursor Integration**: Seamless integration with Cursor
- âœ… **Xcode Integration**: Full Xcode and simulator integration
- âœ… **Git Integration**: Automatic git status and commit suggestions
- âœ… **CI/CD Integration**: Compatible with GitHub Actions

---

## Future Enhancements

### **Planned Features**

1. **AI-Powered Error Fixing**: Automatic code fixes for common errors
2. **Performance Profiling**: Built-in performance analysis
3. **Multi-Device Testing**: Test on multiple simulators simultaneously
4. **Cloud Integration**: Sync with cloud development environments
5. **Advanced Monitoring**: Real-time performance and resource monitoring

### **Advanced Automation**

1. **Predictive Building**: Build before code changes based on context
2. **Smart Testing**: Run only relevant tests based on changes
3. **Intelligent Simulator Management**: Auto-switch between devices
4. **Advanced Log Analysis**: AI-powered log analysis and suggestions

---

## Ensuring Swift Package Changes Are Propagated

When using a modular Swift Package (like SwiftUIKit) and a consuming app (like MLXChatApp), Xcode and SwiftPM can aggressively cache builds and package artifacts. This can cause changes in the library to not appear in the app, even after a clean build. To ensure your changes are always reflected:

### **Best Practices**
- Always clean DerivedData and build artifacts for both the app and the library.
- Run `swift package clean` in both the SwiftUIKit and MLXChatApp directories.
- Uninstall the app from the simulator before reinstalling.
- Regenerate the Xcode project if using xcodegen.
- Use a monorepo workspace and reference SwiftUIKit as a local package.
- Always display a build hash or timestamp in the UI and logs for verification.

### **Recommended Full Clean/Build/Install Script**
```bash
# Clean all derived data and build artifacts
rm -rf ~/Library/Developer/Xcode/DerivedData/*
cd SwiftUIKit && swift package clean && cd ..
cd MLXChatApp && swift package clean && cd ..

# Regenerate Xcode projects if using xcodegen
xcodegen generate

# Uninstall the app from the simulator
xcrun simctl uninstall booted com.clevercoding.MLXChatApp-iOS || true

# Reset the simulator (optional, for stubborn cache issues)
xcrun simctl shutdown "iPhone 16" 2>/dev/null || true
xcrun simctl erase "iPhone 16"

# Build and install the app
xcodebuild -scheme MLXChatApp-iOS -workspace MLXChatApp/MLXChatApp.xcodeproj/project.xcworkspace -destination 'platform=iOS Simulator,name=iPhone 16' clean build
xcrun simctl install booted ~/Library/Developer/Xcode/DerivedData/MLXChatApp-*/Build/Products/Debug-iphonesimulator/MLXChatApp-iOS.app
xcrun simctl launch booted com.clevercoding.MLXChatApp-iOS
```

### **Debug Panel and Build Hash Verification**
- Use the built-in Debug Panel in SwiftUIKit to view the current build hash, build date, and other debug info.
- Always check the build hash in the UI to confirm you are running the latest build.
- If the hash does not change after a code update, repeat the full clean/build/install script above.

### **Troubleshooting**
- If changes to SwiftUIKit do not appear in the app:
  - Ensure you are editing the correct local package and not a cached or remote version.
  - Run the full clean/build/install script.
  - Check the build hash in the UI and logs.
  - If issues persist, try resetting the simulator and regenerating the Xcode project.

---

## Conclusion

The **agent-driven development workflow** transforms Cursor into a truly autonomous development assistant. By automatically handling build, test, and simulator tasks, it allows you to focus entirely on writing code while maintaining confidence that your changes are working correctly.

**Key Benefits:**
- ðŸš€ **50% faster development cycle**
- ðŸŽ¯ **Zero manual build/test commands**
- ðŸ”§ **Automatic error detection and recovery**
- ðŸ“Š **Comprehensive monitoring and logging**
- ðŸŽ® **Seamless simulator integration**

**Next Steps:**
1. **Enable the workflow** by ensuring Cursor settings are applied
2. **Test the automation** by making a small code change
3. **Monitor the results** and adjust configuration as needed
4. **Trust the agent** to handle routine development tasks

---

*Last updated: 2025-06-27* 